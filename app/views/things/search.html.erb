<div class="container">



<!-- Search Menu -->

  <%= form_tag search_path, method: "get" do %>
  <div class="form-group">
     <%= label_tag("Search by Keywords") %>
     <%= text_field_tag(:search, params[:search], class:"form-control") %>
  </div>

  <% @countries = Thing.pluck(:country).uniq!.sort %>
  <div class="form-group">
     <%= label_tag("Country") %>
     <%= select_tag(:country, options_for_select(@countries),include_blank: true, class:"form-control") %>
  </div>
  <% @state = Thing.pluck(:state).uniq!.sort %>
  <div class="form-group">
     <%= label_tag("State") %>
     <%= select_tag(:state, options_for_select(@state),include_blank: true, class:"form-control") %>
  </div>
  <% @city = Thing.pluck(:city).uniq!.sort %>
  <div class="form-group">
     <%= label_tag("City") %>
     <%= select_tag(:city, options_for_select(@city),include_blank: true, class:"form-control") %>
  </div>

  <div class="form-group">
   <%= submit_tag("Search", class:"btn btn-lg btn-info form-control")%>
  </div>
  <% end %>

<!-- Google map display of search result -->
  <div style='width: 800px;'>
    <div id="map" style='width: 800px; height: 400px;'></div>
  </div>

  <script type="text/javascript">
  handler = Gmaps.build('Google');
  handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
    markers = handler.addMarkers(<%=raw @hash.to_json %>);
    handler.bounds.extendWith(markers);
    handler.fitMapToBounds();
  });
  </script>

<!-- Display of Search Results -->

<% @search.each do |t| %>
<div class="well">
<p>spotted by <%= t.user.email %> on <%= t.created_at.strftime('%d %B %Y') %> </p>
<p>Goods/Services: <%= t.name %></p>
<p>vendor: <%= t.vendor %></p>
<p>price: <% t.currency %> <%= t.price %> / <%= t.unit %></p>
<% if logged_in? %>
<!-- add or remove upvotes by current users limiting to only one vote per user -->
<% if t.user != current_user %>
  <div class="voting-box">
    <div class="upvote-button">
      <% if ThingDownvote.find_by(thing_id: t.id, user_id: current_user.id).nil? %>
        <% if ThingUpvote.find_by(thing_id: t.id, user_id: current_user.id).nil? %>
          <%= form_for ThingUpvote.new, url: add_upvote_path, remote: true, method: :post, html:{class:"upvote-form"} do |f| %>
          <%= f.hidden_field :thing_id, value:t.id %>
          <%= f.hidden_field :user_id, value:current_user.id %>
          <%= f.button :submit do  %>
              <i class="glyphicon glyphicon-thumbs-up" id="upvote-button"></i>
             <% end %>
           <% end %>
        <% else %>
          <%= form_for :thing_upvote, url: remove_upvote_path, html:{class:"upvote-form2"}, remote: true, method: :delete do |f| %>
          <%= f.hidden_field :thing_id, value:t.id %>
          <%= f.hidden_field :user_id, value:current_user.id %>
          <%= f.button :submit do %>
              <i class="glyphicon glyphicon-thumbs-up green-color" id="upvote-button2"></i>
             <% end %>
          <% end %>
        <% end %>
      <% else %>
          <%= form_for ThingUpvote.new, url: add_upvote_path do |f| %>
          <%= f.button :submit, disabled:true do %>
              <i class="glyphicon glyphicon-thumbs-up"></i>
             <% end %>
           <% end %>
      <% end %>
      <p id="upvote-count"><%= t.thing_upvotes.count %></p>
    </div>
<!-- add or remove downvotes by current users limiting to only one vote per user -->
    <div class="downvote-button">
      <% if ThingUpvote.find_by(thing_id: t.id, user_id: current_user.id).nil? %>
        <% if ThingDownvote.find_by(thing_id: t.id, user_id: current_user.id).nil? %>
          <%= form_for ThingDownvote.new, url: add_downvote_path, html:{class:"downvote-form"} do |f| %>
          <%= f.hidden_field :thing_id, value:t.id %>
          <%= f.hidden_field :user_id, value:current_user.id %>
          <%= f.button :submit do %>
              <i class="glyphicon glyphicon-thumbs-down" id="downvote-button"></i>
             <% end %>
           <% end %>
        <% else %>
          <%= form_for :thing_downvote, url: remove_downvote_path, html:{class:"downvote-form2"}, method: :delete do |f| %>
          <%= f.hidden_field :thing_id, value:t.id %>
          <%= f.hidden_field :user_id, value:current_user.id %>
          <%= f.button :submit do %>
              <i class="glyphicon glyphicon-thumbs-down red-color" id="downvote-button2"></i>
             <% end %>
          <% end %>
        <% end %>
      <% else %>
          <%= form_for ThingDownvote.new, url: add_downvote_path do |f| %>
          <%= f.button :submit, disabled:true do %>
              <i class="glyphicon glyphicon-thumbs-down"></i>
             <% end %>
           <% end %>
      <% end %>
      <p><%= t.thing_downvotes.count %></p>
    </div>
  </div>
  <% end %>
  <% end %>
</div>
<% end %>

</div>
